# CLAUDE.md — osmose-python

## Project
Python orchestration layer and Shiny web interface for the OSMOSE marine ecosystem simulator. The Java engine is unchanged; Python handles config I/O, execution, output reading, calibration, and visualization.

## Commands
- **Run tests:** `.venv/bin/python -m pytest`
- **Run single test:** `.venv/bin/python -m pytest tests/test_schema.py::test_name -v`
- **Run app:** `.venv/bin/shiny run app.py --host 0.0.0.0 --port 8000`
- **Lint:** `.venv/bin/ruff check osmose/ ui/ tests/`
- **Format:** `.venv/bin/ruff format osmose/ ui/ tests/`

## Architecture
Schema-driven: every OSMOSE parameter is defined once as an `OsmoseField` in `osmose/schema/`. The UI auto-generates forms from schema metadata. Adding a parameter = adding one field to the schema.

```
osmose/          # Core library (usable without Shiny)
  schema/        # Parameter definitions + registry (181 params)
  config/        # Config reader/writer (OSMOSE .csv/.properties format)
  calibration/   # pymoo NSGA-II, GP surrogate, SALib sensitivity
  runner.py      # Async Java subprocess manager
  results.py     # CSV/NetCDF output reader (xarray)
  scenarios.py   # Save/load/compare/fork (JSON)
ui/              # Shiny UI (10 tabs in page_navbar)
  pages/         # One module per tab (*_ui() + *_server())
  components/    # Reusable widgets (param_form, etc.)
  theme.py       # shinyswatch superhero theme
```

## Code Conventions
- Python 3.12+, type hints on public APIs
- Ruff for linting/formatting, line length 100
- Tests in `tests/`, run with pytest, use `.venv/bin/python`
- OSMOSE config keys are lowercase dot-separated (e.g., `species.linf.sp0`)
- Species-indexed params use `sp{idx}` placeholder in `key_pattern`, resolved via `field.resolve_key(idx)`
- Input IDs in Shiny are generated by replacing dots with underscores in key patterns

## Gotchas
- Use `.venv/bin/python`, not `python` (system python may not exist)
- `render_field()` generates Shiny input IDs from `key_pattern.replace(".", "_")` — overlapping prefix filters can cause duplicate IDs (see commit ca4a04c)
- `pyproject.toml` requires `[tool.setuptools.packages.find]` with `include = ["osmose*"]` — without it, setuptools finds `ui/` and `data/` and refuses to build
- Config reader auto-detects separator per line (`;`, `=`, `,`, `:`, tab) — don't assume a single separator
- Runner tests use `_ScriptRunner` subclass with mock Python scripts as fake JARs
- SALib uses `SALib.sample.sobol` (not deprecated `saltelli`)

## Design Docs
- Design: `docs/plans/2026-02-21-osmose-python-port-design.md`
- Plan: `docs/plans/2026-02-21-osmose-python-port-plan.md`
